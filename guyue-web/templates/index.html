<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤æ›° - è·¨æ—¶ç©ºçš„å¿ƒçµæ²»æ„ˆ</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@300;400;600;700&family=Ma+Shan+Zheng&display=swap" rel="stylesheet">
    
    <style>
        /* ========== 1. å…¨å±€å­—ä½“ä¸å˜é‡å®šä¹‰ ========== */
        :root {
            /* æ ¸å¿ƒè‰²ç›˜ */
            --bg-paper: rgba(255, 253, 248, 0.85); /* å®£çº¸ç™½ï¼ˆåŠé€æ˜ï¼‰ */
            --bg-sidebar: rgba(248, 247, 243, 0.6); /* ä¾§è¾¹æ ï¼ˆæ›´é€ï¼‰ */
            --ink-black: #2C2C2C;       /* å¾½å¢¨ */
            --ink-light: #595959;       /* æ·¡å¢¨ */
            --cinnabar: #A83333;        /* æœ±ç ‚çº¢ (ç”¨äºå°ç« /æŒ‰é’®) */
            --bamboo: #4E6E52;          /* ç«¹é’è‰² (ç”¨äºè‚¯å®š/ç”Ÿæœº) */
            --ochre: #B8860B;           /* èµ­çŸ³è‰² (ç”¨äºå¼ºè°ƒ) */
            
            /* é˜´å½±ä¸è¾¹æ¡† */
            --border-ink: rgba(44, 44, 44, 0.08);
            --shadow-float: 0 10px 40px rgba(0, 0, 0, 0.15); /* æ‚¬æµ®é˜´å½± */
            --shadow-card: 0 4px 12px rgba(0, 0, 0, 0.05);   /* å¡ç‰‡é˜´å½± */
            --glass-blur: blur(12px);    /* ç£¨ç ‚ç»ç’ƒæ¨¡ç³Šåº¦ */
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }

        /* ========== 2. æ²‰æµ¸å¼èƒŒæ™¯ ========== */
        body {
            font-family: 'Noto Serif SC', 'SimSun', serif; /* ä¼˜å…ˆå®‹ä½“ */
            color: var(--ink-black);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            
            /* èƒŒæ™¯è®¾ç½®ï¼šä¼˜å…ˆä½¿ç”¨å›¾ç‰‡ï¼Œè‹¥æ— å›¾ç‰‡åˆ™æ˜¾ç¤ºç±³è‰²æ¸å˜ */
            background-color: #EFEBE4; 
            background-image: url('/static/background.png');
            background-size: cover;
            background-position: center;
            background-attachment: fixed; /* èƒŒæ™¯å›ºå®šï¼Œè¥é€ è§†å·®æ„Ÿ */
            
            /* å åŠ ä¸€å±‚æ·¡æ·¡çš„é›¾æ°”é®ç½© */
            position: relative;
        }
        
        body::before {
            content: "";
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(239, 235, 228, 0.2); 
            z-index: -1;
        }

        /* ========== 3. ä¸»å®¹å™¨ (ç»ç’ƒæ‹Ÿæ€ + å®£çº¸) ========== */
        .app-container {
            width: 1100px; 
            height: 750px; 
            max-width: 95vw; 
            max-height: 90vh;
            
            background-color: var(--bg-paper);
            backdrop-filter: var(--glass-blur); /* æ ¸å¿ƒï¼šç£¨ç ‚ç»ç’ƒæ•ˆæœ */
            -webkit-backdrop-filter: var(--glass-blur);
            
            border: 1px solid rgba(255, 255, 255, 0.4);
            border-radius: 12px;
            box-shadow: var(--shadow-float);
            
            display: flex; 
            overflow: hidden; 
            position: relative;
            animation: floatUp 0.8s ease-out; /* å…¥åœºåŠ¨ç”» */
        }

        @keyframes floatUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ========== 4. ä¾§è¾¹æ  (é›…è‡´å¯¼èˆª) ========== */
        .sidebar { 
            width: 200px; 
            padding: 40px 0; 
            background-color: var(--bg-sidebar);
            border-right: 1px solid var(--border-ink); 
            text-align: center;
            display: flex; flex-direction: column;
            z-index: 2;
        }
        
        .logo { 
            font-size: 2.2rem; 
            font-weight: 700; 
            margin-bottom: 50px; 
            letter-spacing: 4px; 
            color: var(--ink-black);
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
            font-family: 'Ma Shan Zheng', cursive; /* ä¹¦æ³•å­—ä½“ */
        }
        
        .nav-item { 
            position: relative;
            padding: 18px 0; 
            cursor: pointer; 
            font-size: 1.05rem; 
            color: var(--ink-light);
            transition: all 0.4s ease;
            letter-spacing: 1px;
        }
        
        /* å¯¼èˆªæ‚¬åœä¸æ¿€æ´»çŠ¶æ€ */
        .nav-item::before {
            content: "";
            position: absolute;
            left: 0; top: 0; bottom: 0;
            width: 4px;
            background-color: var(--cinnabar);
            transform: scaleY(0);
            transition: transform 0.3s ease;
        }
        
        .nav-item:hover { color: var(--cinnabar); background-color: rgba(255,255,255,0.3); }
        
        .nav-item.active {
            color: var(--ink-black);
            font-weight: 600;
            background-color: rgba(255,255,255,0.5);
        }
        .nav-item.active::before { transform: scaleY(1); }
        
        .user-info { 
            margin-top: auto; 
            padding: 20px; 
            font-size: 0.85rem; 
            color: var(--ink-light); 
            border-top: 1px solid var(--border-ink);
        }

        /* ========== 5. å†…å®¹åŒºåŸŸ ========== */
        .content-area { 
            flex: 1; 
            padding: 50px; 
            position: relative; 
            overflow: hidden; 
            background: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0IiBoZWlnaHQ9IjQiPgo8cmVjdCB3aWR0aD0iNCIgaGVpZ2h0PSI0IiBmaWxsPSIjZmZmIi8+CjxyZWN0IHdpZHRoPSIxIiBoZWlnaHQ9IjEiIGZpbGw9IiMwMDAiIG9wYWNpdHk9IjAuMDIiLz4KPC9zdmc+') repeat; /* ææ·¡çš„å™ªç‚¹çº¹ç†å¢åŠ çº¸å¼ æ„Ÿ */
        }
        
        /* ä¿®æ”¹ view ç±»ï¼Œå…è®¸å…¶åœ¨å†…éƒ¨æº¢å‡ºæ—¶æ»šåŠ¨ */
       /* ä¿®æ”¹åçš„ View æ ·å¼ */
      /* çº¦ç¬¬ 135 è¡Œå¼€å§‹æ›¿æ¢ */
        .view {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            padding: 40px;
            box-sizing: border-box;

            /* å¼ºåˆ¶é‡ç½®ï¼šé»˜è®¤çŠ¶æ€ä¸‹ä¸æ˜¾ç¤ºã€æ— èƒŒæ™¯ã€æ— è¾¹æ¡† */
            display: none !important; 
            background: transparent;
            border: none;
            box-shadow: none;
    
            flex-direction: column;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        /* åªæœ‰æ´»è·ƒçš„é¡µé¢æ‰å…è®¸æ‹¥æœ‰å®£çº¸èƒŒæ™¯å’Œæ˜¾ç¤º */
        .view.active {
            display: flex !important;
            background: var(--bg-paper) !important; /* åªæœ‰æ¿€æ´»é¡µæ‰æœ‰å®£çº¸æ„Ÿ */
            opacity: 1 !important;
            z-index: 10;
            pointer-events: auto;
            /* æ¢å¤è¾¹æ¡†æˆ–è£…é¥°ï¼ˆå¦‚æœ‰ï¼‰ */
            border: 1px solid rgba(0,0,0,0.05); 
        }
        /* é’ˆå¯¹ç»“æœé¡µé¢çš„å®¹å™¨ä¼˜åŒ– */
        #result-view {
            display: flex;
            flex-direction: column;
            justify-content: flex-start; /* ä»é¡¶éƒ¨å¼€å§‹æ’åˆ— */
        }
        
        /* ç¡®ä¿ç»“æœå±•ç¤ºåŒºä¸ä¼šæ— é™æ’‘å¤§ */
        .gu-ce-output {
            flex-shrink: 0; /* é˜²æ­¢å†…å®¹è¢«å‹ç¼© */
            margin-bottom: 20px;
            max-height: none; /* ç§»é™¤é«˜åº¦é™åˆ¶ï¼Œä¾é çˆ¶å®¹å™¨æ»šåŠ¨ */
        }

        /* ç¡®ä¿æŒ‰é’®ç»„æœ‰è¶³å¤Ÿçš„åº•éƒ¨é—´è· */
        .result-btn-group {
            margin-top: auto; 
            padding: 30px 0 50px 0; /* å¢åŠ åº•éƒ¨ Paddingï¼Œç¡®ä¿æ»šåŠ¨åˆ°åº•éƒ¨èƒ½çœ‹åˆ°æŒ‰é’® */
            text-align: center;
        }

        /* ========== 6. è¾“å…¥åŒºåŸŸä¸è¡¨å• ========== */
        .input-box {
            background: rgba(255, 255, 255, 0.6);
            border: 1px solid rgba(0,0,0,0.05);
            padding: 40px;
            border-radius: 8px;
            box-shadow: var(--shadow-card);
            margin: 0 auto;
            max-width: 650px;
            width: 100%;
            backdrop-filter: blur(5px);
        }

        textarea { 
            width: 100%; height: 140px; 
            background-color: transparent;
            border: none;
            border-bottom: 2px solid rgba(0,0,0,0.1); 
            padding: 15px; 
            font-family: inherit; font-size: 1.1rem; line-height: 1.8;
            resize: none; margin-top: 10px;
            transition: border-color 0.3s;
            background-image: linear-gradient(rgba(0,0,0,0.03) 1px, transparent 1px);
            background-size: 100% 2.5rem; /* ä¿¡çº¸æ¨ªçº¿æ•ˆæœ */
        }
        textarea:focus { border-bottom-color: var(--bamboo); }
        textarea::placeholder { color: #aaa; font-style: italic; }

        /* ========== 7. æƒ…ç»ªæ»‘å— (æ°´å¢¨æ¸å˜) ========== */
        .emotion-controls { margin: 30px 0; text-align: center; }
        
        .slider-wrapper { 
            display: flex; align-items: center; gap: 15px; margin-top: 15px; 
            font-weight: 600; color: var(--ink-light);
        }
        
        input[type=range] { 
            -webkit-appearance: none; flex-grow: 1; height: 6px; border-radius: 3px;
            background: linear-gradient(90deg, #5D6D7E, #F4F6F7, #A93226); /* å†·ç° -> ç™½ -> çƒ­çº¢ */
            outline: none; cursor: pointer;
        }
        
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; width: 24px; height: 24px; border-radius: 50%;
            background: var(--bg-paper); border: 2px solid var(--ink-light);
            box-shadow: 0 2px 6px rgba(0,0,0,0.2); transition: transform 0.2s;
        }
        input[type=range]::-webkit-slider-thumb:hover { transform: scale(1.2); }
        
        /* åŠ¨æ€æ»‘å—é¢œè‰² */
        .slider-thumb-neg::-webkit-slider-thumb { border-color: #5D6D7E; background: #5D6D7E; }
        .slider-thumb-pos::-webkit-slider-thumb { border-color: var(--cinnabar); background: var(--cinnabar); }
        .slider-thumb-mid::-webkit-slider-thumb { border-color: var(--bamboo); background: var(--bamboo); }

        /* ========== 8. æŒ‰é’® (å°ç« é£æ ¼) ========== */
        .btn-primary { 
            background-color: var(--cinnabar); 
            color: #fff; 
            border: none; 
            padding: 12px 35px; 
            border-radius: 4px; 
            font-size: 1rem; 
            letter-spacing: 2px;
            cursor: pointer; margin-top: 25px; 
            transition: all 0.3s;
            box-shadow: 0 4px 10px rgba(168, 51, 51, 0.3);
            font-family: 'Noto Serif SC', serif;
            position: relative; overflow: hidden;
        }
        
        .btn-primary:hover { 
            background-color: #8B2A2A; 
            transform: translateY(-2px); 
            box-shadow: 0 6px 15px rgba(168, 51, 51, 0.4);
        }
        
        .btn-secondary { 
            background-color: transparent; 
            color: var(--ink-light); 
            border: 1px solid var(--ink-light);
            box-shadow: none;
            margin-left: 10px;
        }
        .btn-secondary:hover { 
            background-color: rgba(0,0,0,0.05); 
            color: var(--ink-black);
            transform: translateY(-2px);
        }
        
        .btn-primary:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        /* ========== 9. ç»“æœå±•ç¤ºåŒº (å¤ç±æ’ç‰ˆ) ========== */
        .gu-yan-output {
            font-size: 1.8rem;
            font-weight: 600;
            text-align: center;
            color: var(--ink-black);
            margin: 40px 0;
            font-family: 'Ma Shan Zheng', cursive; /* ç»“æœç”¨ä¹¦æ³•ä½“ */
            padding: 20px;
            border-top: 1px solid rgba(0,0,0,0.05);
            border-bottom: 1px solid rgba(0,0,0,0.05);
            position: relative;
        }
        
        .gu-yan-output::before { content: "â€œ"; position: absolute; top: -10px; left: 10px; font-size: 4rem; color: rgba(0,0,0,0.1); font-family: sans-serif; }
        .gu-yan-output::after { content: "â€"; position: absolute; bottom: -40px; right: 10px; font-size: 4rem; color: rgba(0,0,0,0.1); font-family: sans-serif; }

        .gu-ce-output {
            font-size: 1.05rem;
            line-height: 2;
            color: var(--ink-light);
            text-align: justify;
            background: rgba(255,255,255,0.4);
            padding: 25px;
            border-radius: 8px;
        }
        .gu-ce-output strong { color: var(--cinnabar); }

        /* ========== 10. æ£®æ—è§†å›¾ (å¡ç‰‡åŒ–) ========== */
        .forest-grid {
            display: flex; flex-wrap: wrap; gap: 20px; 
            padding: 10px; 
            background: transparent; border: none;
            max-height: 550px; overflow-y: auto;
        }
        
        .tree-plot {
            width: 140px; text-align: center; padding: 15px; 
            border: 1px solid rgba(255,255,255,0.6); 
            border-radius: 12px;
            cursor: pointer; transition: all 0.3s;
            background-color: rgba(255,255,255,0.5);
            box-shadow: var(--shadow-card);
        }
        
        .tree-plot:hover {
            transform: translateY(-5px);
            background-color: rgba(255,255,255,0.9);
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
            border-color: var(--bamboo);
        }
        
        .tree-icon { font-size: 3rem; margin-bottom: 10px; filter: drop-shadow(0 4px 4px rgba(0,0,0,0.1)); }

        /* ========== 11. æ—¥å†è§†å›¾ ========== */
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .calendar-header button { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--ink-light); font-weight: bold; transition: color 0.2s; }
        .calendar-header button:hover { color: var(--cinnabar); }
        
        .calendar-grid {
            display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px;
            background-color: transparent; border: none;
            padding: 10px;
        }
        .day-name { text-align: center; padding: 10px 0; color: var(--ink-light); font-weight: 600; }
        
        .day-cell { 
            background-color: rgba(255,255,255,0.5); 
            min-height: 80px; padding: 10px;
            border-radius: 8px; border: 1px solid rgba(0,0,0,0.03);
            position: relative; cursor: default;
            transition: all 0.2s;
        }
        .day-cell:not(.empty-day):hover { background-color: #fff; transform: scale(1.05); z-index: 2; box-shadow: var(--shadow-card); }
        .day-number { font-weight: 700; color: #999; position: absolute; top: 8px; right: 8px; font-size: 0.8rem; }
        
        .has-record { border: 1px solid var(--cinnabar); background-color: rgba(255,253,248,0.9); cursor: pointer !important; }
        .has-record .day-number { color: var(--cinnabar); }
        .record-summary { margin-top: 15px; font-size: 0.75rem; color: var(--bamboo); font-weight: 600; }

        /* ========== 12. æ¨¡æ€æ¡† (ç°ä»£å¼¹çª—) ========== */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            display: none; justify-content: center; align-items: center; z-index: 1000;
            backdrop-filter: blur(5px); 
            background: rgba(0, 0, 0, 0.4); 
        }
        .modal-content {
            background-color: #FFFEFA;
            width: 600px; max-height: 85%; overflow-y: auto;
            border: 1px solid rgba(0,0,0,0.1);
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            border-radius: 12px;
            padding: 40px;
            animation: modalFadeIn 0.3s ease-out;
        }
        @keyframes modalFadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        .modal-content h3 { color: var(--cinnabar); margin-bottom: 15px; border-bottom: 1px dashed var(--border-ink); padding-bottom: 10px; font-size: 1.4rem; }
        .modal-guyan { font-size: 1.4rem; text-align: center; color: var(--ink-black); margin: 20px 0; font-family: 'Ma Shan Zheng', cursive; }
        .modal-guce { font-size: 1rem; line-height: 1.8; color: var(--ink-light); }
        .modal-info { font-size: 0.85rem; color: #888; margin-top: 10px; }
        .water-btn-group { margin-top: 30px; text-align: center; }
        
        /* æ»šåŠ¨æ¡ç¾åŒ– */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.1); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(0,0,0,0.2); }
        /* æ‰‹æœºç«¯é€‚é…ä»£ç  */
        @media (max-width: 768px) {
            .app-container { flex-direction: column; width: 100vw; height: 100vh; max-height: none; border-radius: 0; }
            .sidebar { width: 100%; height: auto; padding: 10px 0; flex-direction: row; justify-content: space-around; border-right: none; border-bottom: 1px solid var(--border-ink); }
            .logo, .user-info { display: none; }
            .content-area { padding: 15px; overflow-y: auto; flex: 1; }
            .view { padding: 15px; position: relative; opacity: 1; display: none; transform: none; }
            .view.active { display: flex; }
            .input-box { padding: 20px; }
            .gu-yan-output { font-size: 1.4rem; margin: 20px 0; }
            .gu-yan-output::before, .gu-yan-output::after { font-size: 2rem; }
        }
    </style>
</head>
<body onload="initApp()">

    <div class="app-container">
        <div class="sidebar">
            <div class="logo">å¤æ›°</div>
            <div id="nav-home" class="nav-item active" onclick="switchView('home')">âœ’ï¸ è®°å½•å¿ƒå¢ƒ</div>
            <div id="nav-forest" class="nav-item" onclick="switchView('forest')">ğŸŒ³ å¤æ›°æ£®æ—</div>
            <div id="nav-calendar" class="nav-item" onclick="switchView('calendar')">ğŸ“… æ—¥å†å›é¡¾</div>
            
            <div class="user-info">
                å½“å‰ç”¨æˆ·: <span id="current-username">è®¿å®¢</span><br>
                <button onclick="loginLogout()" class="btn-primary" style="padding: 5px 10px; margin-top: 10px; font-size: 0.75rem; width: 100%;">åˆ‡æ¢/ç™»å½•</button>
            </div>
        </div>

        <div class="content-area">

            <div id="home-view" class="view active">
                <h2>âœ’ï¸ è®°å½•å¿ƒå¢ƒ</h2>
                <div class="input-box">
                    <p style="text-align: center; margin-bottom: 20px; color: var(--ink-light);">è¯·é€šè¿‡æ»‘åŠ¨æƒ…ç»ªå’Œè¯¦ç»†è®°å½•äº‹ä»¶ï¼Œå¼€å¯æ‚¨çš„æ²»æ„ˆä¹‹æ—…ã€‚</p>
                    
                    <div class="emotion-controls">
                        <p>å¿ƒç»ªæŒ‡æ•°ï¼š<span id="mood-label">å¹³é™å®‰ç¨³ â˜ï¸ (50)</span></p>
                        <div class="slider-wrapper">
                            <span>æ„</span>
                            <input type="range" min="1" max="100" value="50" id="emotion-range" class="slider-thumb-mid">
                            <span>ä¹</span>
                        </div>
                    </div>

                    <label for="user-input" style="display: block; font-weight: 600; margin-bottom: 10px; color: var(--ink-black);">è¯¦ç»†äº‹ä»¶è®°å½•</label>
                    <textarea id="user-input" placeholder="ä»Šæ—¥æ‰€é‡ä½•äº‹ï¼Ÿçƒ¦è¯·ç»†ç»†é“æ¥..."></textarea>

                    <div style="text-align: center;">
                        <button class="btn-primary" id="generate-btn" onclick="generateAndShowResult()">å¤æ›°ä¸€ä¸‹</button>
                    </div>
                </div>
            </div>

            <div id="result-view" class="view">
                <h2>ğŸ“œ å¤è¨€ä¸å¤ç­–</h2>
                <div class="result-scroll-content">
                    <div class="gu-yan-output" id="output-guyan"></div>

                    <div class="gu-ce-output">
                        <strong>ã€å¤ç­–è§£æã€‘</strong><br>
                        <span id="output-guce"></span>
                    </div>

                    <div class="result-btn-group">
                        <button class="btn-primary" onclick="resetAndGoForest()">âœ”ï¸ è®°å…¥å¿ƒç”° & ç§æ ‘</button>
                        <button class="btn-primary btn-secondary" onclick="switchView('home')">â†©ï¸ ä¿®æ”¹æè¿°</button>
                    </div>
                </div>
            </div>

            <div id="forest-view" class="view">
                <h2>ğŸŒ³ å¤æ›°æ£®æ—</h2>
                <p style="color: var(--ink-light); margin-bottom: 20px;">æ¯è®°å½•ä¸€æ¬¡å¿ƒç»ªï¼Œå¤æ›°å°±ä¼šä¸ºæ‚¨ç§ä¸‹ä¸€é¢—æ˜ å°„å½“ä¸‹æƒ…ç»ªçš„æ ‘æœ¨ã€‚</p>
                
                <div class="forest-grid">
                    </div>
            </div>

            <div id="calendar-view" class="view">
                <h2>ğŸ“… å¿ƒç»ªè¶³è¿¹</h2>
                <div class="calendar-header">
                    <button onclick="changeMonth(-1)">&#9664; ä¸Šæœˆ</button>
                    <h3 id="current-month-display" style="font-size: 1.5rem; color: var(--ink-black);"></h3>
                    <button onclick="changeMonth(1)">ä¸‹æœˆ &#9654;</button>
                </div>
                <div class="calendar-grid">
                    </div>
            </div>

        </div>
    </div>

    <div id="review-modal" class="modal-overlay" onclick="closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h3 id="modal-title"></h3>
            <div class="modal-info">
                æ—¥æœŸ: <span id="modal-date"></span> | æƒ…ç»ª: <span id="modal-type"></span> (<span id="modal-score"></span>)
            </div>
            <p style="margin-top: 15px; color: var(--ink-black); line-height: 1.6;"><strong>äº‹ä»¶è®°å½•:</strong> <span id="modal-event"></span></p>
            
            <div style="border-top: 1px dashed var(--border-ink); margin: 20px 0;"></div>
            
            <div class="modal-guyan" id="modal-guyan"></div>
            
            <div class="modal-guce" id="modal-guce"></div>
            <div id="record-pager" style="display:none; align-items:center; justify-content:center; gap: 15px; margin: 15px 0; padding: 10px; border-top: 1px dashed #eee; border-bottom: 1px dashed #eee;">
                <button onclick="changeRecord(-1)" style="cursor:pointer; background:none; border:1px solid #ccc; padding:2px 10px;">â†</button>
                <span id="pager-info" style="font-size:0.9rem; color:#666;">1 / 1</span>
                <button onclick="changeRecord(1)" style="cursor:pointer; background:none; border:1px solid #ccc; padding:2px 10px;">â†’</button>
            </div>
            <div class="water-btn-group">
                <button class="btn-primary" id="water-btn" onclick="waterTree()">ğŸ’¦ æµ‡æ°´ (å¼ºåŒ–/è½¬åŒ–)</button>
                <button class="btn-secondary btn-primary" onclick="closeModal()">å…³é—­</button>
            </div>
        </div>
    </div>

    <script>
// æ ¸å¿ƒå˜é‡
let userRecords = [];
const recordsKey = 'guyueRecords_'; 
let currentUserId = 'guest'; 

const views = document.querySelectorAll('.view');
const navItems = document.querySelectorAll('.nav-item');
const emotionRange = document.getElementById('emotion-range');
const moodLabel = document.getElementById('mood-label');
const userInput = document.getElementById('user-input');
const WEEK_DAYS = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];

let currentRecordIndex = -1; 
let currentDayRecords = []; 
let currentCalendarDate = new Date();
currentCalendarDate.setDate(1); 

// ========== A. ç”¨æˆ·ç™»å½•/æ•°æ®ç®¡ç† ==========

function loginLogout() {
    const newUsername = prompt("è¯·è¾“å…¥æ‚¨çš„ç”¨æˆ·åè¿›è¡Œç™»å½•/åˆ‡æ¢ï¼ˆä¾‹å¦‚: user1, guest, ç­‰ï¼‰ã€‚", currentUserId);
    if (newUsername && newUsername.trim() !== currentUserId) {
        currentUserId = newUsername.trim();
        localStorage.setItem('currentUserId', currentUserId);
        document.getElementById('current-username').innerText = currentUserId;
        loadRecords(); 
        alert(`å·²åˆ‡æ¢åˆ°ç”¨æˆ·ï¼š${currentUserId}ã€‚æ•°æ®å·²æ›´æ–°ã€‚`);
        switchView('home');
    }
}

function loadRecords() {
    const savedRecords = localStorage.getItem(recordsKey + currentUserId);
    userRecords = savedRecords ? JSON.parse(savedRecords) : [];
    userRecords.sort((a, b) => new Date(a.date) - new Date(b.date)); 
}

function saveRecords() {
    localStorage.setItem(recordsKey + currentUserId, JSON.stringify(userRecords));
}

function initApp() {
    const storedUserId = localStorage.getItem('currentUserId');
    if (storedUserId) {
        currentUserId = storedUserId;
    }
    document.getElementById('current-username').innerText = currentUserId;
    loadRecords();
    // è§¦å‘ä¸€æ¬¡è¾“å…¥äº‹ä»¶ä»¥åˆå§‹åŒ–æ˜¾ç¤º
    if (emotionRange) {
        emotionRange.dispatchEvent(new Event('input'));
    }
}

// ========== B. ç•Œé¢å’Œè§†å›¾åˆ‡æ¢é€»è¾‘ ==========

emotionRange.addEventListener('input', function() {
    const val = parseInt(this.value);
    let label = '';
    let icon = '';
    
    this.className = ''; 
    
    // ä¿®æ”¹åçš„æ¸©æ¶¦æªè¾é€»è¾‘
    if (val <= 25) { 
        label = 'å¿ƒæƒ…ä¸æ‚¦'; icon = 'ğŸŒ§ï¸';
        this.classList.add('slider-thumb-neg');
    } else if (val < 45) {
        label = 'å¿ƒæƒ…æ²‰é—·'; icon = 'â˜ï¸';
        this.classList.add('slider-thumb-neg');
    } else if (val > 75) { 
        label = 'ç§¯ææ„‰æ‚¦'; icon = 'â˜€ï¸';
        this.classList.add('slider-thumb-pos');
    } else { 
        label = 'å¹³é™å®‰ç¨³'; icon = 'ğŸƒ';
        this.classList.add('slider-thumb-mid');
    }
    
    moodLabel.innerText = `${label} ${icon} (${val})`;
});

function switchView(viewId) {
    views.forEach(view => {
        view.classList.remove('active');
        // ç¡®ä¿ä½¿ç”¨ display æ§åˆ¶ï¼Œé˜²æ­¢é‡å 
        view.style.display = 'none';
    });
    navItems.forEach(item => item.classList.remove('active'));

    const targetView = document.getElementById(`${viewId}-view`);
    if (targetView) {
        targetView.classList.add('active');
        targetView.style.display = 'flex';
    }
    
    const targetNav = document.getElementById(`nav-${viewId}`);
    if (targetNav) targetNav.classList.add('active');
    
    if (viewId === 'forest') {
        renderForest();
    } else if (viewId === 'calendar') {
        renderCalendar(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth());
    }
}

// ========== C. æ—¥å†ä¸æ£®æ—æ¸²æŸ“é€»è¾‘ ==========

function renderForest() {
    const forestGrid = document.querySelector('#forest-view .forest-grid');
    if (!forestGrid) return;
    forestGrid.innerHTML = ''; 

    userRecords.forEach((record, index) => {
        let icon = '';
        let color = '';
        
        // å¢åŠ å¯¹â€œå¿ƒå¢ƒå‡åâ€ç±»å‹çš„è¯†åˆ«
        if (record.type === 'å¿ƒå¢ƒå‡å') {
            icon = 'ğŸŒ¸';
            color = 'var(--cinnabar)';
        } else if (record.type.includes('ç§¯æ') || record.type.includes('æ„‰æ‚¦')) {
            icon = record.watered ? 'ğŸŒ²' : 'ğŸŒ³'; 
            color = record.watered ? '#2E8B57' : 'var(--bamboo)';
        } else if (record.type.includes('æ²‰é—·') || record.type.includes('ä¸æ‚¦') || record.type.includes('æ¶ˆæ')) {
            icon = record.watered ? 'ğŸŒ±' : 'ğŸ‚'; 
            color = record.watered ? '#6495ED' : '#9F3A3A';
        } else {
            icon = 'ğŸŒ¿';
            color = 'var(--ochre)';
        }

        const plot = document.createElement('div');
        plot.className = 'tree-plot';
        plot.onclick = () => showReviewModal(index); 
        plot.innerHTML = `
            <div class="tree-icon" style="color: ${color};">${icon}</div>
            <p style="font-weight:bold;">${record.type.substring(0, 4)}</p>
            <p style="font-size:0.8rem; color:#888;">${record.date.substring(5)}</p>
            <p style="font-size:0.8rem; color:#aaa;">${record.watered ? '(å·²å‡å)' : ''}</p>
        `;
        forestGrid.appendChild(plot);
    });
}

function renderCalendar(year, month) {
    const grid = document.querySelector('#calendar-view .calendar-grid');
    const display = document.getElementById('current-month-display');
    if (!grid || !display) return;
    grid.innerHTML = ''; 

    display.innerText = `${year}å¹´ ${month + 1}æœˆ`;
    const firstDay = new Date(year, month, 1).getDay(); 
    const daysInMonth = new Date(year, month + 1, 0).getDate();

    WEEK_DAYS.forEach(day => {
        grid.innerHTML += `<div class="day-name">${day}</div>`;
    });

    for (let i = 0; i < firstDay; i++) {
        grid.innerHTML += `<div class="day-cell empty-day"></div>`;
    }

    const recordsByDate = userRecords.reduce((acc, record, index) => {
        const dateKey = record.date; 
        if (!acc[dateKey]) acc[dateKey] = [];
        acc[dateKey].push({ ...record, index });
        return acc;
    }, {});

    for (let day = 1; day <= daysInMonth; day++) {
        const dateKey = `${year}/${String(month + 1).padStart(2, '0')}/${String(day).padStart(2, '0')}`;
        const dayRecords = recordsByDate[dateKey] || [];
        const hasRecord = dayRecords.length > 0;
        
        const dayCell = document.createElement('div');
        dayCell.className = `day-cell ${hasRecord ? 'has-record' : ''}`;
        dayCell.innerHTML = `<div class="day-number">${day}</div>`;
        
        if (hasRecord) {
            dayCell.innerHTML += `<div class="record-summary">${dayRecords[0].type.substring(0, 2)}ç­‰${dayRecords.length}æ¡</div>`;
            dayCell.onclick = () => showReviewModal(dayRecords[0].index);
        }
        grid.appendChild(dayCell);
    }
}

function changeMonth(delta) {
    currentCalendarDate.setMonth(currentCalendarDate.getMonth() + delta);
    renderCalendar(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth());
}

// ========== D. å¼¹çª—ä¸å‡å(æµ‡æ°´)é€»è¾‘ ==========

function showReviewModal(index) {
    const targetRecord = userRecords[index];
    currentDayRecords = userRecords.filter(r => r.date === targetRecord.date);
    currentRecordIndex = currentDayRecords.findIndex(r => r.event === targetRecord.event);
    
    renderModalContent();
    document.getElementById('review-modal').style.display = 'flex';
}

function renderModalContent() {
    const record = currentDayRecords[currentRecordIndex];
    document.getElementById('modal-title').innerText = `å›é¡¾å¿ƒç»ª (${record.type})`;
    document.getElementById('modal-date').innerText = record.date;
    document.getElementById('modal-type').innerText = record.type;
    document.getElementById('modal-score').innerText = record.score;
    document.getElementById('modal-event').innerText = record.event;
    document.getElementById('modal-guyan').innerText = record.guyan;
    document.getElementById('modal-guce').innerText = record.guce;

    const pager = document.getElementById('record-pager');
    if (currentDayRecords.length > 1) {
        pager.style.display = 'flex'; 
        document.getElementById('pager-info').innerText = `${currentRecordIndex + 1} / ${currentDayRecords.length}`;
    } else {
        pager.style.display = 'none'; 
    }

    const waterBtn = document.getElementById('water-btn');
    waterBtn.innerText = record.watered ? "å·²å®Œæˆå¿ƒå¢ƒå‡å" : "ğŸ’§ æµ‡æ°´æ„Ÿæ‚Ÿ";
    waterBtn.disabled = record.watered;
}

function changeRecord(step) {
    currentRecordIndex = (currentRecordIndex + step + currentDayRecords.length) % currentDayRecords.length;
    renderModalContent();
}

function closeModal() {
    document.getElementById('review-modal').style.display = 'none';
}

// ã€æ ¸å¿ƒæ–°åŠŸèƒ½ã€‘æµ‡æ°´è§¦å‘å‡å
async function waterTree() {
    const record = currentDayRecords[currentRecordIndex];
    if (record.watered) return;

    const reflection = prompt(`ã€å›æƒ³å½“æ—¶ã€‘: ${record.event}\n\næ­¤æ—¶æ­¤åˆ»ï¼Œä½ æ˜¯å¦æœ‰æ–°çš„æ„Ÿæ‚Ÿï¼Ÿ`);
    if (reflection === null) return; 

    const waterBtn = document.getElementById('water-btn');
    waterBtn.innerText = "å‡åä¸­...";
    waterBtn.disabled = true;

    try {
        const response = await fetch('/api/generate-guyue', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                emotion_score: record.score,
                event: `ã€åŸäº‹ä»¶ã€‘ï¼š${record.event}ã€‚ ã€æ–°æ„Ÿæ‚Ÿã€‘ï¼š${reflection}`
            })
        });

        const data = await response.json();
        record.watered = true; // æ ‡è®°åŸè®°å½•å·²æµ‡æ°´

        // åˆ›å»ºå‡åæ–°è®°å½•
        const upgradedRecord = {
            date: record.date,
            event: `ã€å‡åæ„Ÿæ‚Ÿã€‘${reflection}`,
            score: Math.min(parseInt(record.score) + 15, 100),
            type: "å¿ƒå¢ƒå‡å",
            guyan: data.guyan,
            guce: data.guce,
            watered: true
        };

        userRecords.push(upgradedRecord);
        saveRecords();
        alert("æµ‡æ°´æˆåŠŸï¼æ„Ÿæ‚Ÿå·²å‡åä¸ºæ–°çš„å¤è¨€ï¼Œå­˜å…¥æ£®æ—ã€‚");
        renderModalContent();
        renderForest();
    } catch (e) {
        alert("ç½‘ç»œæ€ç»ªæ–­äº†ï¼Œè¯·é‡è¯•ã€‚");
    } finally {
        waterBtn.innerText = "ğŸ’§ æµ‡æ°´æ„Ÿæ‚Ÿ";
        waterBtn.disabled = false;
    }
}

// ========== E. AI ç”Ÿæˆé€»è¾‘ ==========

async function generateAndShowResult() {
    const content = userInput.value.trim();
    const emotionScore = emotionRange.value;
    const btn = document.getElementById('generate-btn');
    
    if (content.length < 5) {
        alert("è¯·è¯¦ç»†æè¿°äº‹ä»¶ã€‚");
        return;
    }
    
    btn.disabled = true;
    btn.innerText = "å¤äººæ²‰æ€ä¸­...";

    try {
        const response = await fetch('/api/generate-guyue', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ event: content, emotion_score: emotionScore })
        });
        const data = await response.json();
        document.getElementById('output-guyan').innerText = data.guyan;
        document.getElementById('output-guce').innerText = data.guce;
        switchView('result');
    } catch (e) {
        alert("è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯ã€‚");
    } finally {
        btn.disabled = false;
        btn.innerText = "å¤æ›°ä¸€ä¸‹";
    }
}

function resetAndGoForest() {
    const emotionScore = parseInt(emotionRange.value);
    // ä½¿ç”¨æ–°çš„æ¸©æ¶¦æªè¾
    let emotionType = "";
    if (emotionScore > 75) emotionType = 'ç§¯ææ„‰æ‚¦';
    else if (emotionScore < 45) emotionType = 'å¿ƒæƒ…æ²‰é—·';
    else emotionType = 'å¹³é™å®‰ç¨³';
    
    const today = new Date();
    const dateString = `${today.getFullYear()}/${String(today.getMonth() + 1).padStart(2, '0')}/${String(today.getDate()).padStart(2, '0')}`;

    const newRecord = {
        date: dateString,
        event: userInput.value.trim(),
        score: emotionScore,
        type: emotionType,
        guyan: document.getElementById('output-guyan').innerText,
        guce: document.getElementById('output-guce').innerText,
        watered: false 
    };
    
    userRecords.push(newRecord);
    saveRecords(); 
    alert(`å·²å°†å¿ƒç»ªè®°å…¥ï¼Œç§ä¸‹ä¸€é¢— ${emotionType} æ ‘ã€‚`);
    
    userInput.value = "";
    emotionRange.value = 50;
    emotionRange.dispatchEvent(new Event('input'));
    switchView('forest');
}
    </script>
</body>

</html>











